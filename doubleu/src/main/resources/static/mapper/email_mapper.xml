<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.doubleu.email.mybatis.EmailMapper">
	<!-- select -->
	
	<!-- 메일함 사이드 바 cnt -->
	<select id="selectSendEmail" resultType="int">
		SELECT count(*) FROM(
			SELECT a.*, b.member_mid 
			FROM email a, member b
				WHERE a.member_no = b.member_no
				AND b.member_mid = #{memberMid}
				ORDER BY a.email_date DESC)
	</select>

    <!-- 페이지 -->
	<select id="totListSizeMain" resultType='int' parameterType="com.doubleu.email.vo.EmailPage">
		SELECT count(email_no) FROM email
		WHERE email_title LIKE '%${findStr}%'
	</select>
	
	 <select id="selectPaging" 
	 resultMap="getEmailListSelect" 
	 parameterType="com.doubleu.email.vo.EmailPage">
    SELECT * from (
        SELECT rownum no, m.* from (  
           SELECT * from email em join member mem on em.member_no=mem.member_no
           WHERE email_title LIKE '%${findStr}%'
           AND mem.member_mid = #{memberMid}
           ORDER BY em.email_date DESC
           ) m   
        ) WHERE no between ${startNo} and ${endNo}
	</select>
	
	<select id="selectEmailNo" parameterType="int" resultMap="getEmailListSelect">
		SELECT * FROM email
		WHERE email_no = #{emailNo}
	</select>
	
	<select id="selectFiles" parameterType="int" resultMap="attList">
		SELECT b.file_orifile, a.* 
		FROM email a, email_files b 
		WHERE a.email_no = b.email_no AND a.email_no = #{emailNo}
	</select>
	
	
	<!-- 받는 사람 -->
	<select id="selectSendPerson" parameterType="int" resultMap="revList">
		SELECT c.*, a.email_no
		FROM email a, email_receiver c 
		WHERE a.email_no = c.email_no 
		AND c.email_ref = 0 
		AND a.email_no = #{emailNo}
	</select>
	
	<!-- 참조 -->
	<select id="selectRefPerson" parameterType="int" resultMap="revList">
		SELECT c.*, a.email_no
		FROM email a, email_receiver c 
		WHERE a.email_no = c.email_no 
		AND c.email_ref = 1
		AND a.email_no = #{emailNo}
	</select>
	
	
	<!-- insert -->
	<insert id='insertSendWrite' parameterType="com.doubleu.email.vo.EmailMainVo">
		INSERT ALL
		INTO email(
		email_no, 
		member_no,
		member_mid,
		email_address, 
		email_name, 
		email_title, 
		email_date, 
		email_contents, 
		email_mailbox, 
		email_chk, email_delete) 
		VALUES(
		email_main_seq.nextval,
		#{memberNo},
		#{memberMid}, 
		#{emailAddress}, #{emailName}, 
		#{emailTitle}, SYSTIMESTAMP, 
		#{emailContents}, 
		default, 
		#{emailChk}, 
		default)

		<if test="attFileList != null">
			<foreach collection="attFileList" item="att">
				INTO email_files(files_no, email_no, file_sysfile, file_orifile)
				VALUES (
				emailMainSeq(), 
				email_main_seq.currval, 
				#{att.sysFile, jdbcType=VARCHAR}, 
				#{att.oriFile})
			</foreach>
		</if> 
		
		<if test="emailRevList != null">
			<foreach collection="emailRevList" item="rev">
				INTO email_receiver (
					    email_rev_no,
					    email_no,
					    email_rev_address,
					    email_ref)
				VALUES(
				emailMainSeq(), 
				email_main_seq.currval, 
				#{rev.emailReceiverAddress}, 
				#{rev.emailReceiverRef})
				
				<!-- VALUES(emailMainSeq(), email_main_seq.currval, #{emailReceiverName}, #{emailReceiverAddress}, #{emailReceiverDept}, #{emailReceiverRef}, #{emailMid}) -->
			</foreach>
		</if>
		SELECT * FROM dual
	</insert>
	
	<resultMap id="getEmailListSelect" type="com.doubleu.email.vo.EmailMainVo">
 
	<result property="emailNo" column="email_no" />
	<result property="memberNo" column="member_no" />
	<result property="memberMid" column="member_mid" /> 
	<result property="emailAddress" column="email_address" /> 
	<result property="emailName" column="email_name" /> 
	<result property="emailTitle" column="email_title" /> 
	<result property="emailDate" column="email_date"  /> 
	<result property="emailContents" column="email_contents"/>  
	<result property="emailMailBox" column="email_mailbox" />
	<result property="emailChk" column="email_chk" /> 
	<result property="emailDelete" column="email_delete" /> 

	</resultMap>
	
	<resultMap id="attList" type="com.doubleu.email.vo.AttEmailVo">
		<result property="filesNo" column="files_no"/>
		<result property="emailNo" column="email_no"/>
		<result property="sysFile" column="file_sysfile"/>
		<result property="oriFile" column="file_orifile"/>
	</resultMap>
	
	
	<resultMap id="revList" type="com.doubleu.email.vo.EmailReceiverVo">
		<result property="emailReceiverNo" column="email_rev_no"/>
		<result property="emailNo" column="email_no"/>
		<result property="emailReceiverName" column="email_rev_name"/>
		<result property="emailReceiverAddress" column="email_rev_address"/>
		<result property="emailReceiverDept" column="email_rev_department"/>
		<result property="emailReceiverRef" column="email_ref"/>
		<result property="emailMid" column="email_mid"/>
	</resultMap>
</mapper>